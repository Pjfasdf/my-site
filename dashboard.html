<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ticker Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .scroll-container {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: auto;
      width: 100%;
    }

    .scroll-container table {
      width: 100%;
      table-layout: fixed;
    }

    table {
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background-color: #333;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .light-blue { background-color: #e0f7ff; }
    .light-gray { background-color: #f0f0f0; }
    .strike-blue { background-color: #add8e6; }

    .curr-border-row {
      outline: 5px solid #ffeb3b;
      outline-offset: -2px;
      box-shadow: 0 0 10px 3px #fff176;
      background-color: rgba(255, 255, 0, 0.2);
    }
  </style>
</head>
<body>

  <h2 id="title">Details</h2>
  <div class="scroll-container">
    <table id="details-table"></table>
  </div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ticker = urlParams.get('ticker');
    document.getElementById('title').textContent = `Details for ${ticker}`;

    fetch('dashboard.csv')
      .then(response => response.text())
      .then(csv => {
        const results = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const data = results.data.filter(row => row.TICKER === ticker);
        const table = document.getElementById('details-table');
        table.innerHTML = '';

        if (data.length === 0) {
          table.innerHTML = '<tr><td>No data found for this ticker.</td></tr>';
          return;
        }

        const columns = Object.keys(data[0]);
        const groupHeaderRow = document.createElement('tr');
        const headerRow = document.createElement('tr');
        const oiVolGroups = [...]; // your existing group definitions
        const oiGroups = [...];
        const zoneVolCols = [...];
        const zoneOiCols = [...];
        const zoneCols = [...zoneVolCols, ...zoneOiCols];
        const negNegOiCols = [...];
        const oiVolCols_0 = [...];
        const gexOiBarCols = [...];
        const powerOiCols = [...];
        const zeroAsEmptyCols = [...];
        const darkerBlueCols = [...];
        const grayCols = [...];
        const purpleCols = [...];
        const lightBlueCols = [...];
        const lightGrayCols = [...];
        const strikeCols = [...];

        const maxValues = {};
        gexOiBarCols.forEach(col => {
          maxValues[col] = Math.max(...data.map(row => Math.abs(parseFloat(row[col]) || 0)));
        });

        // Group headers
        let i = 0;
        while (i < columns.length) {
          const col = columns[i];
          const th = document.createElement('th');
          const matchGroup = (groupList, label) => {
            for (const group of groupList) {
              if (col === group[0]) {
                th.textContent = label;
                th.colSpan = group.length;
                th.style.backgroundColor = '#555';
                th.style.color = 'white';
                groupHeaderRow.appendChild(th);
                i += group.length;
                return true;
              }
            }
            return false;
          };
          if (matchGroup(oiVolGroups, 'OI+VOL')) continue;
          if (matchGroup(oiGroups, 'OI')) continue;
          th.textContent = '';
          groupHeaderRow.appendChild(th);
          i++;
        }
        table.appendChild(groupHeaderRow);

        // Column headers
        columns.forEach(col => {
          const th = document.createElement('th');
          if (col.includes('GEX')) th.textContent = 'GEX';
          else if (col.includes('ZONE')) th.textContent = 'Z';
          else if (col.includes('POWER')) th.textContent = 'P';
          else if (col.includes('NEG_NEG')) th.textContent = 'N/N';
          else if (col.includes('DTE')) th.textContent = 'DTE';
          else if (col.includes('DEX')) th.textContent = 'DEX';
          else th.textContent = col;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Data rows
        data.forEach(row => {
          const tr = document.createElement('tr');
          if (row['CURR'] === 'CURR') tr.classList.add('curr-border-row');

          columns.forEach(key => {
            const td = document.createElement('td');
            const value = row[key];
            td.textContent = value;

            if (zeroAsEmptyCols.includes(key) && parseFloat(value) === 0) td.textContent = '';
            if (lightBlueCols.includes(key)) td.classList.add('light-blue');
            if (lightGrayCols.includes(key)) td.classList.add('light-gray');
            if (strikeCols.includes(key)) td.classList.add('strike-blue');
            if (darkerBlueCols.includes(key)) { td.style.backgroundColor = '#90caf9'; td.style.color = 'black'; }
            if (grayCols.includes(key)) { td.style.backgroundColor = '#d3d3d3'; td.style.color = 'black'; }
            if (purpleCols.includes(key)) { td.style.backgroundColor = '#d1c4e9'; td.style.color = 'black'; }
            if (zoneCols.includes(key)) { td.style.fontSize = '16px'; td.style.fontWeight = 'bold'; }

            if (zoneVolCols.includes(key) && ['M', 'M+', 'M-'].includes(value.trim())) {
              td.style.backgroundColor = 'yellow'; td.style.color = 'black'; td.style.fontWeight = 'bold';
            }

            if (zoneOiCols.includes(key) && ['M', 'M+', 'M-'].includes(value.trim())) {
              td.style.backgroundColor = 'black'; td.style.color = 'yellow'; td.style.fontWeight = 'bold';
            }

            if (negNegOiCols.includes(key)) {
              if (!isNaN(parseFloat(value))) {
                td.style.backgroundColor = '#ccffcc'; td.style.color = 'black'; td.style.fontWeight = 'bold';
              } else if (value.trim() === 'N/N') {
                td.style.backgroundColor = '#f28b82'; td.style.color = 'white'; td.style.fontWeight = 'bold';
              }
            }

            if (value.trim() === '*') {
              td.style.backgroundColor = '#00bfff'; td.style.fontWeight = 'bold';
            } else if (value.trim() === '+') {
              td.style.backgroundColor = '#39ff14'; td.style.color = 'black'; td.style.fontWeight = 'bold';
            } else if (value.trim() === '-') {
              if (zoneCols.includes(key)) {
                td.style.backgroundColor = 'fuchsia'; td.style.color = 'black'; td.style.fontWeight = 'bold';
              } else {
                td.style.backgroundColor = 'red'; td.style.color = 'green'; td.style.fontWeight = 'bold';
              }
            }

            if (oiVolCols_0.includes(key)) {
              const num = parseFloat(value);
              if (!isNaN(num)) {
                const abs = Math.min(Math.abs(num), 100);
                const lightness = 90 - (abs / 100) * 50;
                const hue = num >= 0 ? 120 : 0;
                td.style.backgroundColor = `hsl(${hue}, 100%, ${lightness}%)`;
                td.style.color = 'black';
                td.textContent = num >= 0 ? '+' : '-';
              }
            }

            if (gexOiBarCols.includes(key)) {
              const num = parseFloat(value);
              const max = maxValues[key];
              if (!isNaN(num) && max > 0) {
                td.innerHTML = '';
                const bar = document.createElement('div');
                bar.style.height = '12px';
                bar.style.width = `${(Math.abs(num) / max) * 100}%`;
                bar.style.backgroundColor = num >= 0 ? 'green' : 'red';
                bar.style.margin = '0 auto 0 0';
                bar.style.borderRadius = '2px';
                td.appendChild(bar);
              }
            }

            if (['DEX_AVG', 'DEX_AVG0', 'DEX_0'].includes(key)) {
              const num = parseFloat(value);
              if (!isNaN(num)) {
                const abs = Math.min(Math.abs(num), 100);
                const lightness = 90 - (abs / 100) * 50;
                const hue = num >= 0 ? 120 : 0;
                td.style.backgroundColor = `hsl(${hue}, 100%, ${lightness}%)`;
                td.style.color = 'black';
                td.textContent = num >= 0 ? '+' : '-';
              }
            }

            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      });
  </script>

</body>
</html>
