<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="refresh" content="30">
  <title>Watchlist Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #333; color: white; }
    tr:hover {
      outline: 2px solid magenta;
      background-color: #ffe1ff;
      cursor: pointer;
    }
    .highlight-ticker { background-color: #cce5ff; color: #004085; }
    .entry-good { background-color: #39ff14; color: #000; font-weight: bold; }
    .entry-orange { background-color: orange; color: #000; font-weight: bold; }
    .target-blue { background-color: #cce5ff; color: #004085; }
    .target-darkblue { background-color: #0074cc; color: #fff; font-weight: bold; }
    .no-trade { background-color: #000; color: #fff; font-weight: bold; }
    #refresh-time {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>

  <h2>Watchlist Dashboard</h2>
  <div id="refresh-time"></div>
  <table id="data-table"></table>

<script>
  const refreshTime = new Date();
  const refreshDiv = document.getElementById('refresh-time');
  refreshDiv.textContent = 'Last refresh: ' + refreshTime.toLocaleString();

  // Load execution status timestamps
  fetch('watchlist_execution_status.csv')
    .then(response => response.text())
    .then(csv => {
      const results = Papa.parse(csv, { header: true, skipEmptyLines: true });
      const data = results.data;

      if (data.length > 0) {
        const latest = data[data.length - 1]; // Use last row
        const etradeTime = latest['ETRADE_DOWNLOAD_TIME'];
        const excelTime = latest['EXCEL_DOWNLOAD_TIME'];

        const extraInfo = document.createElement('div');
        extraInfo.innerHTML = `
          <div><strong>E*TRADE Download:</strong> ${etradeTime}</div>
          <div><strong>Excel Download:</strong> ${excelTime}</div>
        `;
        refreshDiv.appendChild(extraInfo);
      }
    });

  // Load watchlist data
  fetch('watchlist.csv')
    .then(response => response.text())
    .then(csv => {
      const results = Papa.parse(csv, { header: true, skipEmptyLines: true });
      const data = results.data;
      const table = document.getElementById('data-table');
      table.innerHTML = '';

      const headerRow = document.createElement('tr');
      Object.keys(data[0]).forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      data.forEach(row => {
        const tr = document.createElement('tr');
        Object.entries(row).forEach(([key, value]) => {
          const td = document.createElement('td');
          const cleanValue = value.trim();

          if (key === 'TICKER') {
            const link = document.createElement('a');
            link.href = `dashboard.html?ticker=${encodeURIComponent(cleanValue)}`;
            link.textContent = cleanValue;
            link.style.color = 'inherit';
            link.style.textDecoration = 'underline';
            td.appendChild(link);

            if (['SPX', 'SPY', 'QQQ', 'IWM'].includes(cleanValue.toUpperCase())) {
              td.classList.add('highlight-ticker');
            }
          } else {
            td.textContent = value;
          }

          if (key === 'ENTRY_SIGNAL') {
            if (cleanValue === 'Under Ult Entry | GOOD profit') {
              td.classList.add('entry-good');
            } else if (cleanValue === 'Under 0 Entry | GOOD profit') {
              td.classList.add('entry-orange');
            }
          }

          if (key === 'TARGET_PRICE') {
            td.classList.add('target-blue');
          }

          const match = value.match(/([-+]?\d+(\.\d+)?)%/);
          if (match) {
            const percent = parseFloat(match[1]);

            if (key === 'TARGET_PRICE' && percent > 2) {
              td.classList.remove('target-blue');
              td.classList.add('target-darkblue');
            }

            if (key === 'FIRST_ENTRY_PRICE_0DTE' && percent < 0) {
              let bgColor = percent >= -0.5 ? '#ffe5cc' :
                            percent >= -1   ? '#ffcc99' :
                            percent >= -2   ? '#ff9933' : '#ff6600';
              td.style.backgroundColor = bgColor;
              td.style.color = '#000';
              td.style.fontWeight = 'bold';
            }

            if (key === 'ULTIMATE_ENTRY_PRICE') {
              if (percent < 0) {
                let bgColor = percent >= -0.5 ? '#eaffea' :
                              percent >= -1   ? '#caffca' :
                              percent >= -2   ? '#aaffaa' : '#66ff66';
                td.style.backgroundColor = bgColor;
                td.style.color = '#000';
                td.style.fontWeight = 'bold';
              } else if (percent >= 0 && percent <= 1.5) {
                td.style.backgroundColor = '#ffff99';
                td.style.color = '#000';
                td.style.fontWeight = 'bold';
              } else if (percent > 1.5) {
                td.style.backgroundColor = '#ffffff';
                td.style.color = '#000';
              }
            }
          }

          if (cleanValue.includes('NO Trade')) {
            td.classList.add('no-trade');
          }

          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    });
</script>

</body>
</html>
